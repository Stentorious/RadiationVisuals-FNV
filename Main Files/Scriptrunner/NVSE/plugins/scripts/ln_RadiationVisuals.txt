; Radiation Visuals - Stentorious

; On game restart
if eval Goo1.AuxVarGetFlt "*RadVis_Init" 0 != 1
	Goo1.AuxVarSetFlt "*RadVis_Init" 1 0

	; Check for requirements
	if GetNVSEVersion > 5 && GetNVSERevision > 2 && GetNVSEBeta > 2
	else
		MessageBoxEx "Radiation Visuals missing requirement!%rInstall xNVSE 6.3.3+."
		return
	endif
	if GetPluginVersion "JohnnyGuitarNVSE" < 455
		MessageBoxEx "Radiation Visuals missing requirement!%rInstall latest JohnnyGuitar NVSE plugin."
		return
	endif
	Goo1.AuxVarSetFlt "*RadVis_Init" 1 1

	; Load INI config
	SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_ParticleStrength" (GetMaxOf 0 (GetMinOf 2 (GetINIFloat "Effect:fParticleStrength" "Stentorious\RadiationVisuals.ini")))
	SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_StaticStrength" (GetMaxOf 0 (GetMinOf 1 (GetINIFloat "Effect:fStaticStrength" "Stentorious\RadiationVisuals.ini")))
	SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_RadMin" (GetMaxOf 0 (GetINIFloat "General:fRadiationMin" "Stentorious\RadiationVisuals.ini"))
	SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_RadMax" (GetMaxOf (GetUIFloatAlt "HUDMainMenu\RadiationVisuals\_RadMin") (GetINIFloat "General:fRadiationMax" "Stentorious\RadiationVisuals.ini"))
	Goo1.AuxVarSetFlt "*RadVis_INI" ((GetMaxOf 0 (GetMinOf 1 (GetINIFloat "Effect:fBlurStrength" "Stentorious\RadiationVisuals.ini"))) / 102) 0
	Goo1.AuxVarSetFlt "*RadVis_INI" ((GetMaxOf 0 (GetMinOf 1 (GetINIFloat "Effect:fDoubleVisionStrength" "Stentorious\RadiationVisuals.ini"))) / 10200) 1
	Goo1.AuxVarSetFlt "*RadVis_INI" ((GetMaxOf -1 (GetMinOf 5 (GetINIFloat "Effect:fSaturationStrength" "Stentorious\RadiationVisuals.ini"))) / 255) 2
	Goo1.AuxVarSetFlt "*RadVis_INI" ((GetMaxOf -1 (GetMinOf 1 (GetINIFloat "Effect:fContrastStrength" "Stentorious\RadiationVisuals.ini"))) / 1275) 3
	Goo1.AuxVarSetFlt "*RadVis_INI" ((GetMaxOf -1 (GetMinOf 1 (GetINIFloat "Effect:fBrightnessStrength" "Stentorious\RadiationVisuals.ini"))) / 85) 4
	if eval GetINIFloat "General:bPrioritizeHelmetOverlay" "Stentorious\RadiationVisuals.ini"
		SetUIFloatAlt "HUDMainMenu\RadiationVisuals\depth" -5000
	endif

	; Set particle color
	string_var sINI = GetINIString "Effect:sParticleColor" "Stentorious\RadiationVisuals.ini"
	int iLength = Sv_Length sINI
	if eval iLength == 6 && TestExpr (ToNumber sINI 1 1)
		SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_ParticleRed" (ToNumber (sINI[0:1]) 1)
		SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_ParticleGreen" (ToNumber (sINI[2:3]) 1)
		SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_ParticleBlue" (ToNumber (sINI[4:5]) 1)
	elseif eval iLength == 1 && TestExpr (ToNumber sINI 0 1)
		SetUIFloatAlt "HUDMainMenu\RadiationVisuals\_ParticleSystemcolor" (ToNumber sINI)
	endif
	Sv_Destruct sINI

	; Disable MUX's radiation visuals
	SetUIFloatAlt "HUDMainMenu\RadiationMeter\MUX_Radiation\Effect\visible" 0

	; Animation control
	SetUIFloatGradual "HUDMainMenu\RadiationVisuals\ParticleWeak\_index" 0 10.999 0.55 3
	SetUIFloatGradual "HUDMainMenu\RadiationVisuals\ParticleAverage\_index" 0 9.999 0.5 3
	SetUIFloatGradual "HUDMainMenu\RadiationVisuals\ParticleStrong\_index" 0 8.999 0.45 3

	; Set IMOD traits
	SetImageSpaceModTrait HouseDecorationRaider 37 1	; Saturation (Mult)
	SetImageSpaceModTrait HouseDecorationRaider 38 0	; Saturation (Add)
	SetImageSpaceModTrait HouseDecorationRaider 39 1	; Contrast (Mult)
	SetImageSpaceModTrait HouseDecorationRaider 40 0	; Contrast (Add)
	SetImageSpaceModTrait HouseDecorationRaider 42 0	; Contrast (Add)
	SetImageSpaceModTrait HouseDecorationRaider 47 255	; Tint (Red)
	SetImageSpaceModTrait HouseDecorationRaider 48 255	; Tint (Green)
	SetImageSpaceModTrait HouseDecorationRaider 49 255	; Tint (Blue)
	SetImageSpaceModTrait HouseDecorationRaider 50 0	; Tint (Alpha)

	; Event handlers
	SetGameMainLoopCallback (CompileScript "RadiationVisuals\MainLoop.gek") 1 10 3

	; Reset effect on fast travel
	SetOnFastTravelEventHandler (begin Function {ref rMapMarker}
		RIMOD HouseDecorationRaider
		Goo1.AuxVarSetFlt "*RadVis_IMOD" 0
		SetUIFloatGradual "HUDMainMenu\RadiationVisuals\_RadEnvironment" 0
		SetUIFloatGradual "HUDMainMenu\RadiationVisuals\_RadInstant" 0
	end) 1

	; Update effect on instantaneous radiation (Eg. Eating food)
	if eval GetINIFloat "General:bInstantaneousVisuals" "Stentorious\RadiationVisuals.ini"
		SetOnActorValueChangeEventHandler 1 (begin Function {int iAVCode, float fPreviousValue, float fNewValue}
			if eval (fNewValue -= fPreviousValue) > 0 && Player.GetRadiationLevelAlt == 0
				SetUIFloatGradual "HUDMainMenu\RadiationVisuals\_RadInstant" fNewValue 0 2
			endif
		end) 0 54
	endif

endif

; On game load
if eval Goo1.AuxVarGetFlt "*RadVis_Init" 1
	RIMOD HouseDecorationRaider
	Goo1.AuxVarSetFlt "*RadVis_IMOD" 0
	SetUIFloatGradual "HUDMainMenu\RadiationVisuals\_RadEnvironment" 0
	SetUIFloatGradual "HUDMainMenu\RadiationVisuals\_RadInstant" 0
endif